<!--
created: Jan 5, 2026
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<style>
    body {
        font-family: Arial, sans-serif;
        background: #000;
        color: #eee;
    }

    button {
        font-size: 16px;
        padding: 10px 18px;
        cursor: pointer;
        margin-bottom: 30px;
        background: #333;
        color:gray;
    }
</style>
</head>
<body>

<div style="text-align:center">
    <button id="start">Start Audio Capture</button><br>
    <canvas id="meter" width="420" height="200"></canvas><br>
    <pre style="opacity:0.5" id="message"></pre>
</div>

<script>
const startBtn = document.getElementById("start");
const canvas = document.getElementById("meter");
const ctx = canvas.getContext("2d");
const message = document.querySelector("#message")

const audioContext = new AudioContext({});

const analyser = audioContext.createAnalyser();
analyser.fftSize = 2048;
analyser.smoothingTimeConstant = 0.5
const freqData = new Float32Array(analyser.frequencyBinCount);
const slowFreq = new Float32Array(analyser.frequencyBinCount);

function dbToLinear(db) {
    return Math.pow(10, db / 20);
}
function linearToDb(linear){
    return Math.log10(linear) * 20
}

let started = false
async function startCapture(){
    if(started) return
    try {
        const stream = await navigator.mediaDevices.getDisplayMedia({
            video: true,
            audio: true,
            selfBrowserSurface:"include"
        });

        let source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);

        await initConn()

        audioContext.resume()
        updateAudio();
        started = true
    } catch (err) {
        alert("Audio capture failed: " + err.message);
    }
}

startBtn.onclick = startCapture

let conn = null
async function initConn(){
    conn = new WebSocket("ws://localhost:8765")
    await new Promise((resolve) => {conn.onopen=resolve; conn.onerror=resolve})
    if(conn.readyState === conn.OPEN) message.textContent = "connected"
    else conn = null
}

let fastLoudness = 0, slowLoudness = 0
let avgLowBeat = 0, avgHighBeat = 0
let randomBeatTimer = 0, nextRandomBeat = 20
let shown = false
function updateAudio() {
    analyser.getFloatFrequencyData(freqData)
    const nyquist = audioContext.sampleRate / 2;
    const lowStart = Math.floor(40 / nyquist * freqData.length);
    const lowEnd   = Math.floor(120 / nyquist * freqData.length);

    const {max} = Math

    let lowSum = 0, highSum = 0, volume = 0
    for (let i = lowStart; i < freqData.length; i++) {
        let freq = freqData[i] = dbToLinear(freqData[i])
        //volume += freq
        slowFreq[i] += (freq - slowFreq[i]) * 0.4
        let change = freq - slowFreq[i]
        if (change < slowFreq[i] * 0.15) continue;
        if(i < lowEnd) lowSum += change
        else highSum += change
    }

    let lowBeat = max(lowSum,0)*100
    let highBeat = max(highSum,0)*100
    avgLowBeat += (max(lowBeat,1)-avgLowBeat) * (avgLowBeat<lowBeat?0.5:0.05)
    avgHighBeat += (max(highBeat,1)-avgHighBeat) * (avgHighBeat<highBeat?0.5:0.05)
    lowBeat /= avgLowBeat
    highBeat /= avgHighBeat

    randomBeatTimer++
    if(highBeat>0.75) randomBeatTimer = 0
    if(randomBeatTimer > nextRandomBeat){
        nextRandomBeat = Math.random()*40+20
        randomBeatTimer = -Math.random()*10 // beat lasts for random amount of time
    }
    let highBeat_randomBeat = randomBeatTimer < 0 ? 0.75 : highBeat

    if(conn) conn.send(lowBeat+","+highBeat_randomBeat)

    if(shown){
    // Draw
    const w = canvas.width;
    const h = canvas.height;

    ctx.clearRect(0, 0, w, h);

    /*ctx.fillStyle="#ccc"
    for (let i = 0; i < freqData.length; i++) {
        ctx.fillRect(0,i,(freqData[i]-slowFreq[i])*10000,1)
    }*/

	drawMeter(120, 0, lowBeat, "lowBeat", 1, "#a55");
	drawMeter(220, 0, highBeat, "highBeat", 1, "#55a");
	drawMeter(20, 10, avgLowBeat, "avgLowBeat", 10, "#400")
	drawMeter(320, 10, avgHighBeat, "avgHighBeat", 10, "#008")
    }
	

    setTimeout(updateAudio, 50);
}

canvas.onclick = () => shown = !shown

function drawMeter(x, y, amount, title, scale=1, color="#aaa") {
    const height = canvas.height - 45;
    const width = 50;

    // Label
    ctx.fillStyle = "gray";
    ctx.font = "14px monospace";
    ctx.fillText(title, x, y+height+16);
    ctx.fillText(amount.toFixed(4), x, y+height+32)

    // Meter fill
    const fillHeight = amount/scale*height;
    ctx.fillStyle = color;
    ctx.fillRect(x, y+height-fillHeight, width, fillHeight);

    // Border
    ctx.strokeStyle = "#444";
    ctx.strokeRect(x, y, width, height);
}


message.textContent = `cd ${location.pathname.substring(0,location.pathname.lastIndexOf("/"))}; source .venv/bin/activate; python a.py`


function goto(x){document.querySelector('#browser').src=x; startCapture()}
</script>

<div style="position:absolute; left:0; bottom:0">
<button onclick="goto('https://bandcamp.com/EmbeddedPlayer/album=944225423/size=large/')">e</button>
<button onclick="goto('https://tommustbe12.com/soundtrack/album1/')">t1</button>
<button onclick="goto('https://tommustbe12.com/soundtrack/')">t</button>
<br>
<iframe id="browser" width="150" height="400" style="border:none" referrerpolicy="no-referrer"></iframe>
</div>

</body>
</html>
