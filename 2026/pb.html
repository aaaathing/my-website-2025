<!--
Jan 5, 2026
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<style>
    body {
        font-family: Arial, sans-serif;
        background: #111;
        color: #eee;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 40px;
    }

    button {
        font-size: 16px;
        padding: 10px 18px;
        cursor: pointer;
        margin-bottom: 30px;
    }

    canvas {
        background: #222;
        border-radius: 8px;
    }
</style>
</head>
<body>

<button id="start">Start Audio Capture</button>

<canvas id="meter" width="420" height="200"></canvas>

<script>
const startBtn = document.getElementById("start");
const canvas = document.getElementById("meter");
const ctx = canvas.getContext("2d");

const audioContext = new AudioContext();

const analyser = audioContext.createAnalyser();
analyser.fftSize = 2048;
analyser.smoothingTimeConstant = 0.5;
const freqData = new Float32Array(analyser.frequencyBinCount);
const slowFreq = new Float32Array(analyser.frequencyBinCount);

function dbToLinear(db) {
    return Math.pow(10, db / 20);
}

/*let oscillator = audioContext.createOscillator();
let oscillatorGain = audioContext.createGain();
oscillator.frequency.value = 100
oscillator.type = "triangle"
oscillatorGain.gain.value = 0
oscillator.connect(oscillatorGain).connect(audioContext.destination);
oscillator.start()*/

startBtn.onclick = async () => {
    try {
        const stream = await navigator.mediaDevices.getDisplayMedia({
            video: true,
            audio: true
        });

        let source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);

        audioContext.resume()
        updateAudio();
    } catch (err) {
        alert("Audio capture failed: " + err.message);
    }
};

let fastLoudness = 0, slowLoudness = 0
let avgLowBeat = 0, avgHighBeat = 0
let randomBeatTimer = 0, nextRandomBeat = 20
function updateAudio() {
    analyser.getFloatFrequencyData(freqData)
    /*let sumSquares = 0;
    for (let i = 0; i < dataArray.length; i++) {
        const v = (dataArray[i] - 128) / 128;
        sumSquares += v * v;
    }*/
    const nyquist = audioContext.sampleRate / 2;
    //const low = Math.floor(20 / nyquist * freqData.length);
    const high = Math.floor(150 / nyquist * freqData.length);

    const {max} = Math

    let lowSum = 0, highSum = 0
    for (let i = 0; i < freqData.length; i++) {
        let freq = freqData[i] = dbToLinear(freqData[i])
        slowFreq[i] += (freq - slowFreq[i]) * 0.02
        let change = max(freq - slowFreq[i], 0)
        if(i < high) lowSum += change
        else highSum += change
    }

    //let beat = sum/freqData.length * 10000
    let lowBeat = lowSum/(high) * 10000
    let highBeat = highSum/(freqData.length-high) * 10000
    avgLowBeat += (max(lowBeat,0.2)-avgLowBeat) * (lowBeat > avgLowBeat ? 0.1 : 0.01)
    avgHighBeat += (max(highBeat,0.2)-avgHighBeat) * (highBeat > avgHighBeat ? 0.1 : 0.01)
    lowBeat /= avgLowBeat
    highBeat /= avgHighBeat

    randomBeatTimer++
    if(highBeat>0.75) randomBeatTimer = 0
    if(randomBeatTimer > nextRandomBeat){
        nextRandomBeat = Math.random()*40+20
        randomBeatTimer = -Math.random()*10 // beat lasts for random amount of time
    }
    if(randomBeatTimer < 0) highBeat = 0.75

    //oscillatorGain.gain.value = (highBeat+lowBeat)

    // Draw
    const w = canvas.width;
    const h = canvas.height;

    ctx.clearRect(0, 0, w, h);

    /*ctx.fillStyle="#ccc"
    for (let i = 0; i < freqData.length; i++) {
        ctx.fillRect(0,i,(freqData[i]-slowFreq[i])*10000,1)
    }*/

	//drawMeter(12, 20, beat, "Beat");
	drawMeter(12, 60, lowBeat, "lowBeat");
	drawMeter(12, 100, highBeat, "highBeat");
	

    setTimeout(updateAudio, 50);
}
function drawMeter(x, y, amount, title, fillStyle="#ff0") {
    const width = canvas.width - 24;
    const height = 18;

    // Label
    ctx.fillStyle = "#ccc";
    ctx.font = "14px monospace";
    ctx.fillText(
        `${title}: ${amount.toFixed(4)}`,
        x,
        y - 6
    );

    // Meter fill
    const fillWidth = amount*width;
    ctx.fillStyle = fillStyle;
    ctx.fillRect(x, y, fillWidth, height);

    // Border
    ctx.strokeStyle = "#444";
    ctx.strokeRect(x, y, width, height);
}


async function initConn(){
    
}

</script>

</body>
</html>
